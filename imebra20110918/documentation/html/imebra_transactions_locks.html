<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>imebra: Transactions and common locks</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="style.1.7.5.1.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">imebra
   &#160;<span id="projectnumber">build 2011-09-18_22-24-41</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Introduction</span></a></li>
      <li class="current"><a href="pages.html"><span>User&#160;manual</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('imebra_transactions_locks.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Transactions and common locks </div>  </div>
</div>
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="imebra_transactions_locks_introduction"></a>
Introduction</h2>
<p>In order to keep the dataSet in a consistent state while several threads read and write into it, the following features have been introduced in Imebra:</p>
<ul>
<li><a class="el" href="imebra_transactions_locks.html#imebra_locks">The common locks</a></li>
<li><a class="el" href="imebra_transactions_locks.html#imebra_transactions">The transactions</a></li>
</ul>
<p>A common lock is a mutex shared by several objects; it is used by <a class="el" href="classpuntoexe_1_1imebra_1_1data_set.html">puntoexe::imebra::dataSet</a> and all its components (<a class="el" href="classpuntoexe_1_1imebra_1_1data_group.html">puntoexe::imebra::dataGroup</a> and <a class="el" href="classpuntoexe_1_1imebra_1_1data.html">puntoexe::imebra::data</a> objects) and by the <a class="el" href="classpuntoexe_1_1imebra_1_1image.html">puntoexe::imebra::image</a> and its buffer (<a class="el" href="classpuntoexe_1_1imebra_1_1buffer.html">puntoexe::imebra::buffer</a>).</p>
<p>The transactions objects force the update of several elements in "one go". This means that when several writing handlers are deallocated, the modifications are kept on hold until the transaction object is deallocated; if one of the modifications doesn't complete successfully then all the modifications are rolled back and the dataSet remains in a consistent state.</p>
<h2><a class="anchor" id="imebra_locks"></a>
The common locks</h2>
<p>It is used by the dataSet and by the image objects: it is a mutex that is shared by all the objects owned by the dataSet and by the image. For instance, if when a single tag is locked by using the <a class="el" href="classpuntoexe_1_1lock_object.html">puntoexe::lockObject</a> class then all the dataSet where the tag is contained is also locked, together with all the groups and tags contained by the dataSet.</p>
<p>This is useful when an application has to read several tags and has to be sure that all the retrieved tags represents that dataSet's status at the same moment in time. In order to do this the application must lock the dataSet object; this will lock all the groups and the tags contained in the dataSet and will ensure that other threads will be paused when they try to modify the dataSet. Once the dataSet has been locked the application can read all the tags and rest assured that all of them represents a consistent status of the dataSet.</p>
<p>The shared lock should be released as soon as possible in order to minimize the pause time in the threads that are trying to access to the dataSet.</p>
<h2><a class="anchor" id="imebra_transactions"></a>
The transactions</h2>
<p>The application can include several dataSets update in one or more nested transactions: if one of the updates included in one transaction fails then all the updates included in the same transaction are rolled back.</p>
<p>A single transaction can involve updates on different dataSets.</p>
<p>Imebra provides two kind of transactions:</p>
<ul>
<li>committing transactions</li>
<li>non-committing transactions</li>
</ul>
<p>A committing transaction tries to commits all the changes made to the tags when the transaction is closed, while a non-committing transaction delegates the commit to the parent transaction; this means that only a nested transaction can be a non-committing transaction and Imebra will always create a committing transaction for non nested ones.</p>
<p>In order to include one or more write operations in a transaction the application has to enclose them in a transaction block. A transaction block is initiated by the macro <a class="el" href="transaction_8h.html#a5b824bcd583d54536ede4a7058d8dffe" title="Start a non-committing transaction block.">IMEBRA_TRANSACTION_START()</a> or <a class="el" href="transaction_8h.html#aa9e5ca09eb91480c731e54f24ad2f14c" title="Start a committing transaction block.">IMEBRA_COMMIT_TRANSACTION_START()</a> and is terminated by the macro <a class="el" href="transaction_8h.html#ad9ba484b96e7f19f9f93fd5a0d0cf8a9" title="Terminates a transaction block initiated by IMEBRA_COMMIT_TRANSACTION_START() or IMEBRA_TRANSACTION_S...">IMEBRA_TRANSACTION_END()</a>.</p>
<p>For instance, the following code tries to write a value in the tags 0010,0010 (patient's name) and 0010,1010 (patient's age). If an error occurs inside the transaction block then both the tags will retain their initial value.</p>
<div class="fragment"><pre class="fragment"><span class="keyword">using namespace </span>puntoexe;
<span class="comment">// Create the dataset and setup the charset</span>
<a class="code" href="classpuntoexe_1_1ptr.html" title="This class represents a shared pointer which keeps track of the allocated objects that derive from th...">ptr&lt;imebra::dataSet&gt;</a> myDataSet(<span class="keyword">new</span> dataSet);
<a class="code" href="group__group__dataset.html#gabdae3bfebe84127bfda27b5df4db2f20" title="Defines a list of widechar strings.">imebra::tCharsetsList</a> myCharsets;
myCharsets.push_back(L<span class="stringliteral">&quot;ISO_IR 192&quot;</span>); <span class="comment">// UTF-8</span>
myDataSet-&gt;setCharsetsList(&amp;myCharsets);

<span class="comment">// Write the initial values in the</span>
myDataSet-&gt;setUnicodeString(0x0010, 0, 0x0010, 0, L<span class="stringliteral">&quot;Initial^name&quot;</span>);
myDataSet-&gt;setUnsignedLong(0x0010, 0, 0x1010, 0, 10); <span class="comment">// ten years old</span>

<a class="code" href="transaction_8h.html#a5b824bcd583d54536ede4a7058d8dffe" title="Start a non-committing transaction block.">IMEBRA_TRANSACTION_START</a>();
<span class="comment">// If an error occurs here then the two tags will retain their</span>
<span class="comment">//  initial state</span>
myDataSet-&gt;setUnicodeString(0x0010, 0, 0x0010, 0, L<span class="stringliteral">&quot;Surname^name&quot;</span>);
myDataSet-&gt;setUnsignedLong(0x0010, 0, 0x1010, 0, 20); <span class="comment">// twenty years old</span>

<span class="comment">// The values have not been written yet, only when the transaction</span>
<span class="comment">//  commits them they will be transferred into the dataset</span>
<a class="code" href="transaction_8h.html#ad9ba484b96e7f19f9f93fd5a0d0cf8a9" title="Terminates a transaction block initiated by IMEBRA_COMMIT_TRANSACTION_START() or IMEBRA_TRANSACTION_S...">IMEBRA_TRANSACTION_END</a>();

<span class="comment">// The transaction wrote the new values in the dataset.</span>
<span class="comment">// If an error occurred during the transaction, an exception</span>
<span class="comment">//  has been thrown and must be handled.</span>
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">
    <a href="http://imebra.com">Imebra.com</a></li>
   </ul>
 </div>


</body>
</html>
