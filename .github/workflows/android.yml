# GitHub CI workflow for building DICOMautomaton Android APK.
#
# This workflow:
#   1. Installs the Android NDK/SDK on a standard ubuntu-latest runner.
#   2. Cross-compiles Ygor, Explicator, SDL2, and Boost for arm64-v8a and x86_64.
#   3. Uses Gradle + CMake to assemble a debug APK containing the
#      SDL_Viewer native library (dcma_sdl_viewer).
#   4. Uploads the APK as a GitHub Actions artifact.
#
# The build is an MVP / feasibility build; it does not sign or publish the APK.
#
# Pre-compiled dependencies are installed into /android-deps/<abi>/  so that
# the CMakeLists.txt can locate them automatically via CMAKE_ANDROID_ARCH_ABI.

name: Android APK Build

on:
  push:
    branches: [ master, android ]
    paths:
      - 'android/**'
      - 'src/Operations/SDL_Viewer*'
      - 'src/Challenges/*'
      - 'src/imgui20210904/**'
      - 'src/implot20210904/**'
      - 'docker/builders/android/**'
      - 'docker/build_bases/android/**'
      - '.github/workflows/android.yml'
  workflow_dispatch:

jobs:
  build_android_apk:
    name: Build Android APK (arm64-v8a + x86_64)
    runs-on: ubuntu-latest
    timeout-minutes: 300
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK and build tools
        run: |
             sdkmanager "ndk;26.3.11579264" "build-tools;34.0.0" "platforms;android-34"
             echo "ANDROID_NDK_ROOT=${ANDROID_SDK_ROOT}/ndk/26.3.11579264" >> "${GITHUB_ENV}"

      - name: Install host build dependencies
        run: |
             sudo apt-get update --yes
             sudo apt-get install --yes --no-install-recommends \
                 cmake \
                 ninja-build \
                 git \
                 rsync

      - name: Prepare Android dependencies directory
        run: |
             # Create /android-deps as user-writable so subsequent build steps
             # do not need sudo for mkdir or cmake --install.
             sudo mkdir -p /android-deps
             sudo chown -R "$USER:$USER" /android-deps

      - name: Cache cross-compiled Android dependencies
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: /android-deps
          key: android-deps-v3-${{ runner.os }}-${{ hashFiles('docker/builders/android/**', 'docker/build_bases/android/**', '.github/workflows/android.yml') }}

      - name: Cross-compile SDL2 for Android
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
             set -eux
             git clone --depth=1 --branch release-2.28.5 \
                 'https://github.com/libsdl-org/SDL' /tmp/sdl2

             for abi in arm64-v8a x86_64 ; do
                 prefix="/android-deps/${abi}"
                 mkdir -p "${prefix}"

                 cmake -S /tmp/sdl2 -B "/tmp/sdl2_build_${abi}" \
                     -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake" \
                     -DANDROID_ABI="${abi}" \
                     -DANDROID_PLATFORM=android-26 \
                     -DCMAKE_INSTALL_PREFIX="${prefix}" \
                     -DCMAKE_BUILD_TYPE=Release \
                     -DSDL_SHARED=ON \
                     -DSDL_STATIC=OFF \
                     -GNinja

                 cmake --build "/tmp/sdl2_build_${abi}" --parallel "$(nproc)"
                 cmake --install "/tmp/sdl2_build_${abi}"
             done

      - name: Cross-compile Boost for Android
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
             set -eux
             # Download Boost source (compiled for filesystem, iostreams, serialization, thread).
             BOOST_VERSION="1.83.0"
             BOOST_SHA256="6478edfe2f3305127cffe8caf73ea0176c53769f4bf1585be237eb30798c3b8e"
             BOOST_URL="https://boostorg.jfrog.io/artifactory/main/release/${BOOST_VERSION}/source/boost_$(echo ${BOOST_VERSION} | tr . _).tar.bz2"
             wget --quiet -O /tmp/boost.tar.bz2 "${BOOST_URL}"
             echo "${BOOST_SHA256}  /tmp/boost.tar.bz2" | sha256sum -c -
             tar -xjf /tmp/boost.tar.bz2 -C /tmp/
             BOOST_SRC="/tmp/boost_$(echo ${BOOST_VERSION} | tr . _)"

             # Bootstrap Boost.Build for the host.
             cd "${BOOST_SRC}"
             ./bootstrap.sh --prefix=/tmp/boost-host --without-libraries=python

             for abi in arm64-v8a x86_64 ; do
                 prefix="/android-deps/${abi}"
                 mkdir -p "${prefix}"

                 case "${abi}" in
                     arm64-v8a)
                         ndk_arch="arm64"
                         ndk_triple="aarch64-linux-android26"
                         ;;
                     x86_64)
                         ndk_arch="x86_64"
                         ndk_triple="x86_64-linux-android26"
                         ;;
                 esac

                 TOOLCHAIN="${ANDROID_NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64"
                 CXX="${TOOLCHAIN}/bin/${ndk_triple}-clang++"
                 CC="${TOOLCHAIN}/bin/${ndk_triple}-clang"

                 # Write a Boost.Build user-config for Android cross-compilation.
                 cat > /tmp/boost_user_config_${abi}.jam <<JAM_EOF
             using clang : android_${ndk_arch}
                 : ${CXX}
                 : <cxxflags>"-fPIC"
                   <compileflags>"-fPIC"
                 ;
             JAM_EOF

                 ./b2 \
                     --user-config=/tmp/boost_user_config_${abi}.jam \
                     toolset="clang-android_${ndk_arch}" \
                     target-os=android \
                     address-model=64 \
                     link=static \
                     threading=multi \
                     --prefix="${prefix}" \
                     --with-filesystem \
                     --with-iostreams \
                     --with-serialization \
                     --with-thread \
                     --with-system \
                     -j "$(nproc)" \
                     install 2>&1 | tail -30
             done

      - name: Cross-compile Ygor for Android
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
             set -eux
             git clone --depth=1 'https://github.com/hdclark/Ygor' /tmp/ygor

             for abi in arm64-v8a x86_64 ; do
                 prefix="/android-deps/${abi}"
                 mkdir -p "${prefix}"

                 cmake -S /tmp/ygor -B "/tmp/ygor_build_${abi}" \
                     -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake" \
                     -DANDROID_ABI="${abi}" \
                     -DANDROID_PLATFORM=android-26 \
                     -DCMAKE_INSTALL_PREFIX="${prefix}" \
                     -DCMAKE_BUILD_TYPE=Release \
                     -DBUILD_SHARED_LIBS=OFF \
                     -DWITH_LINUX_SYS=OFF \
                     -DBOOST_ROOT="${prefix}" \
                     -GNinja

                 cmake --build "/tmp/ygor_build_${abi}" --parallel "$(nproc)"
                 cmake --install "/tmp/ygor_build_${abi}"
             done

      - name: Cross-compile Explicator for Android
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
             set -eux
             git clone --depth=1 'https://github.com/hdclark/Explicator' /tmp/explicator

             for abi in arm64-v8a x86_64 ; do
                 prefix="/android-deps/${abi}"
                 mkdir -p "${prefix}"

                 cmake -S /tmp/explicator -B "/tmp/explicator_build_${abi}" \
                     -DCMAKE_TOOLCHAIN_FILE="${ANDROID_NDK_ROOT}/build/cmake/android.toolchain.cmake" \
                     -DANDROID_ABI="${abi}" \
                     -DANDROID_PLATFORM=android-26 \
                     -DCMAKE_INSTALL_PREFIX="${prefix}" \
                     -DCMAKE_BUILD_TYPE=Release \
                     -DBUILD_SHARED_LIBS=OFF \
                     -GNinja

                 cmake --build "/tmp/explicator_build_${abi}" --parallel "$(nproc)"
                 cmake --install "/tmp/explicator_build_${abi}"
             done

      - name: Write local.properties for Gradle
        run: |
             cat > android/local.properties <<EOF
             sdk.dir=${ANDROID_SDK_ROOT}
             ndk.dir=${ANDROID_NDK_ROOT}
             EOF

      - name: Build debug APK with Gradle
        run: |
             set -o pipefail
             cd android
             chmod +x gradlew
             ./gradlew assembleDebug \
                 --no-daemon \
                 --stacktrace \
                 2>&1 | tee /tmp/gradle_build.log

      - name: Collect APK artifacts
        run: |
             mkdir -p ci_artifacts
             find android -name "*.apk" -exec cp {} ci_artifacts/ \;
             ls -lh ci_artifacts/
             find ci_artifacts/ -name '*.apk' -print \
                 -execdir bash -c 'sha256sum "$@" > "$@.sha256sum"' bash '{}' \;

      - name: Upload APK to GitHub Actions
        uses: actions/upload-artifact@v4
        with:
          name: DICOMautomaton-android-debug-apk
          if-no-files-found: error
          path: |
                ci_artifacts/*.apk
                ci_artifacts/*.apk.sha256sum
